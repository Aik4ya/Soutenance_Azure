<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Messagerie Azure</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: auto; padding: 2em; }
    textarea { width: 100%; height: 60px; }
    ul { list-style: none; padding: 0; }
    li { margin-bottom: 0.5em; border-bottom: 1px solid #ddd; padding-bottom: 0.5em; }
  </style>
</head>
<body>
  <h1>ðŸŸ¦ API de Messagerie</h1>

  <div id="login">
    <input id="username" placeholder="Nom d'utilisateur" />
    <button onclick="login()">Se connecter</button>
  </div>

  <div id="app" style="display: none;">
    <p>ConnectÃ© en tant que <b id="currentUser"></b> <button onclick="logout()">DÃ©connexion</button></p>

    <textarea id="messageText" placeholder="Ton message..."></textarea><br />
    <button onclick="sendMessage()">Envoyer</button>

    <h2>ðŸ’¬ Messages</h2>
    <ul id="messagesList"></ul>
  </div>

  <script>
    const API = 'https://monbackendapppython.azurewebsites.net/';

    async function login() {
      const username = document.getElementById('username').value;
      if (!username) return alert("Nom d'utilisateur requis");

      const res = await fetch(`${API}/login`, {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username })
      });

      if (res.ok) {
        document.getElementById('login').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        document.getElementById('currentUser').innerText = username;
        fetchMessages();
      } else {
        const error = await res.json();
        alert(error.error || 'Erreur de connexion');
      }
    }

    async function logout() {
      await fetch(`${API}/logout`, { method: 'POST', credentials: 'include' });
      document.getElementById('login').style.display = 'block';
      document.getElementById('app').style.display = 'none';
    }

    async function sendMessage() {
      const text = document.getElementById('messageText').value;
      if (!text) return alert("Message vide");

      const res = await fetch(`${API}/send_message`, {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text })
      });

      if (res.ok) {
        document.getElementById('messageText').value = '';
        fetchMessages();
      } else {
        const error = await res.json();
        alert(error.error || 'Erreur envoi message');
      }
    }

    async function fetchMessages() {
      const res = await fetch(`${API}/get_messages`, { credentials: 'include' });
      const messages = await res.json();

      const ul = document.getElementById('messagesList');
      ul.innerHTML = '';
      messages.forEach(msg => {
        const li = document.createElement('li');
        li.innerHTML = `<b>${msg.username}</b>: ${msg.text} <i>(${new Date(msg.timestamp).toLocaleString()})</i>`;
        ul.appendChild(li);
      });
    }

    fetchMessages();
  </script>
</body>
</html>
